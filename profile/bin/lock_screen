#!/bin/bash

# Hack to change HipChat status to away when locking screen. This could be less
# hacky by connecting to hipchat using the "--message" option. However, this
# option only appears to support "about", "logout", "quit" and "wakeup"
#
# Tested in KDE (Kubuntu 16.10)
#
# Change HipChat status to away -> Lock screen -> Change HipChat status to
# available after screen is unlocked
#
# Requires xdotool

pid=$(pidof HipChat4)

function lock_screen() {
    cinnamon-screensaver-command -l
}

function change_hipchat_status() {
    # Put spaces between the characters
    COMMAND="slash"
    for x in $(echo ${1} | grep -o .); do
        COMMAND="$COMMAND $x"
    done
    COMMAND="$COMMAND KP_Enter"
    echo "'$COMMAND'"
    xdotool search --name HipChat windowfocus key $COMMAND
}

if [ "${pid}z" != "z" ]; then
    change_hipchat_status away
    lock_screen

    # Example DBus message:
    # signal time=1495310079.829721 sender=:1.1 -> destination=(null destination) serial=11004 path=/org/gnome/SessionManager/Presence; interface=org.gnome.SessionManager.Presence; member=StatusChanged
    #     uint32 0
    dbus-monitor --session "type='signal',interface='org.gnome.SessionManager.Presence',member='StatusChanged'," |
        while read x; do
            if [ "${x}" = "uint32 0" ]; then
                change_hipchat_status here
                exit 0
            fi
        done
else
    lock_screen
fi
